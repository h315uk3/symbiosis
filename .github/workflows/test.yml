name: Tests

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.claude/rules/**'
      - 'LICENSE'
      - '.gitignore'
      - 'CLAUDE.md'
      - 'CONTRIBUTING.md'
      - 'mise.toml'
      - 'ruff.toml'
      - '.vscode/**'
      - '.github/instructions.md'
      - '**.schema.json'
      - '.claude-plugin/marketplace.json'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.claude/rules/**'
      - 'LICENSE'
      - '.gitignore'
      - 'CLAUDE.md'
      - 'CONTRIBUTING.md'
      - 'mise.toml'
      - 'ruff.toml'
      - '.vscode/**'
      - '.github/instructions.md'
      - '**.schema.json'
      - '.claude-plugin/marketplace.json'

jobs:
  test:
    name: Python Doctests & Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install mise
        uses: jdx/mise-action@v2
        with:
          cache: true

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/uv
            .venv
          key: python-deps-${{ runner.os }}-${{ hashFiles('**/pyproject.toml', '**/uv.lock') }}
          restore-keys: |
            python-deps-${{ runner.os }}-

      - name: Install dependencies with mise
        run: mise install

      - name: Check code formatting (ruff)
        run: mise run format --check

      - name: Run linter (ruff)
        run: mise run lint

      - name: Run Python doctests (213 tests)
        run: mise run test

      - name: Run validation (config + tests)
        run: mise run validate

      - name: Test summary
        if: always()
        run: |
          echo "::notice::✓ Python doctests: 213 tests across 16 modules"
          echo "::notice::✓ All checks completed"
